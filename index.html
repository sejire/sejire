<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sejire - –î—Ä–µ–≤–æ –ø—Ä–µ–¥–∫–æ–≤</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvg@4.0.0/lib/index.min.js"></script> <style>
        :root { --green: #27ae60; --red: #e74c3c; --gray: #7f8c8d; --bg: #f8f9fa; --node-bg: #fff; --node-border: #ddd; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; background: var(--bg); padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 700px; text-align: center; }
        .card { background: var(--node-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--node-border); border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--green); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 5px 0; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #app { display: none; }
        .network-info { font-size: 10px; color: var(--gray); margin-bottom: 10px; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è D3.js –¥–µ—Ä–µ–≤–∞ */
        .tree-container-svg { width: 100%; overflow-x: auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        .node circle { fill: #fff; stroke: var(--green); stroke-width: 2px; }
        .node text { font-size: 12px; font-weight: bold; fill: #333; text-anchor: middle; }
        .link { fill: none; stroke: #ccc; stroke-width: 1.5px; }

        .danger-btn { background: var(--red); font-size: 0.8em; }
        .save-btn { background: #3498db; }
        .download-png-btn { background: #f39c12; } /* –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è PNG */
    </style>
</head>
<body>

<div class="container">
    <div class="network-info" id="net">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ª–æ–∫–∞–ª—å–Ω–æ...</div>

    <div id="auth" class="card">
        <h1>Sejire</h1>
        <input type="text" id="u" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="p" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()">–í–æ–π—Ç–∏</button>
    </div>

    <div id="app">
        <div class="card">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–∫–∞</h3>
            <input type="text" id="name" placeholder="–§–ò–û">
            <select id="role">
                <option value="–û—Ç–µ—Ü">–û—Ç–µ—Ü –¥–ª—è...</option>
                <option value="–ú–∞—Ç—å">–ú–∞—Ç—å –¥–ª—è...</option>
            </select>
            <select id="child-select">
                <option value="me">–ú–µ–Ω—è (–æ—Å–Ω–æ–≤–∞–Ω–∏–µ)</option>
            </select>
            <button onclick="save()">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥–µ—Ä–µ–≤–æ</button>
        </div>

        <div class="tree-container-svg" id="tree-svg-display">
            <svg id="tree-canvas" width="100%" height="500"></svg>
        </div>
       
        <div style="margin-top: 30px;">
            <button class="save-btn" onclick="exportToFile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤ .txt</button>
            <button class="save-btn" onclick="downloadSvg()">üñºÔ∏è –°–∫–∞—á–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É (.svg)</button>
            <button class="download-png-btn" onclick="downloadPng()">üì∑ –°–∫–∞—á–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É (.png)</button>
            <button class="danger-btn" onclick="clearTree()">‚ö†Ô∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë –¥–µ—Ä–µ–≤–æ</button>
            <button onclick="location.reload()" style="background:#888;">–í—ã–π—Ç–∏</button>
        </div>
    </div>
</div>

<script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://relay.peer.ooo/gun']);
    const user = gun.user().recall({storage: true});
    let localData = {}; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
    let currentTreeData = []; // –î–∞–Ω–Ω—ã–µ –¥–ª—è D3.js

    // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ç–∏
    setInterval(() => {
        const count = Object.keys(gun.back('opt.peers')).length;
        document.getElementById('net').innerText = count > 0 ? `–°–µ—Ç—å –∞–∫—Ç–∏–≤–Ω–∞ (–£–∑–ª–æ–≤: ${count})` : "–†–∞–±–æ—Ç–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ...";
    }, 2000);

    function login() {
        const u = document.getElementById('u').value;
        const p = document.getElementById('p').value;
        user.auth(u, p, ack => {
            if (ack.err) user.create(u, p, res => auth());
            else showApp();
        });
    }

    function showApp() {
        document.getElementById('auth').style.display = 'none';
        document.getElementById('app').style.display = 'block';
       
        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–∞–Ω–Ω—ã—Ö
        user.get('sejire_final').map().on((data, id) => {
            if (!data || !data.name) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ
           
            localData[id] = { id, ...data }; // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            updateChildSelect(); // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
            renderD3Tree(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º D3 –¥–µ—Ä–µ–≤–æ
        });
    }

    function updateChildSelect() {
        const childSelect = document.getElementById('child-select');
        childSelect.innerHTML = '<option value="me">–ú–µ–Ω—è (–æ—Å–Ω–æ–≤–∞–Ω–∏–µ)</option>'; // –í—Å–µ–≥–¥–∞ –µ—Å—Ç—å "–Ø"
       
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ—Ö, –∫—Ç–æ —É–∂–µ –µ—Å—Ç—å –≤ –¥–µ—Ä–µ–≤–µ
        Object.values(localData).forEach(person => {
            const opt = document.createElement('option');
            opt.value = person.id;
            opt.innerText = person.name;
            childSelect.appendChild(opt);
        });
    }

    function save() {
        const nameInput = document.getElementById('name');
        const role = document.getElementById('role').value;
        const child = document.getElementById('child-select').value;
       
        if (nameInput.value) {
            user.get('sejire_final').get(Gun.text.random()).put({
                name: nameInput.value,
                role: role,
                child: child
            });
            nameInput.value = '';
        }
    }

    // --- D3.js –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è ---
    function renderD3Tree() {
        const treeData = buildD3TreeData(localData);
        if (!treeData) {
            document.getElementById('tree-canvas').innerHTML = '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="16px" fill="#777">–ù–∞—á–Ω–∏—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –ø—Ä–µ–¥–∫–æ–≤!</text>';
            return;
        }

        const svg = d3.select("#tree-canvas");
        svg.selectAll("*").remove(); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –¥–µ—Ä–µ–≤–æ

        const margin = {top: 20, right: 90, bottom: 30, left: 90};
        const width = 600 - margin.left - margin.right;
        let height = 500 - margin.top - margin.bottom;

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const treemap = d3.tree().size([width, height]);

        // –ö–æ—Ä–Ω–µ–≤–æ–π —ç–ª–µ–º–µ–Ω—Ç (—ç—Ç–æ "–Ø" –∏–ª–∏ —Å–∞–º—ã–π –Ω–∏–∂–Ω–∏–π –ø—Ä–µ–¥–æ–∫)
        const root = d3.hierarchy(treeData, d => d.children);

        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–æ—Ä–µ–Ω—å –Ω–∞ "–Ø"
        root.x0 = width / 2;
        root.y0 = 0;

        const tree = treemap(root);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–µ—Ä–µ–≤–∞ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ SVG
        let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
        root.each(d => {
            minX = Math.min(minX, d.x);
            maxX = Math.max(maxX, d.x);
            minY = Math.min(minY, d.y);
            maxY = Math.max(maxY, d.y);
        });

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ SVG
        height = maxY - minY + 100; // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø
        svg.attr("height", height + margin.top + margin.bottom);
        treemap.size([width, height]); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–µ—Ä–µ–≤–æ —Å –Ω–æ–≤–æ–π –≤—ã—Å–æ—Ç–æ–π
        treemap(root); // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è

        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≥—Ä—É–ø–ø—É, —á—Ç–æ–±—ã –¥–µ—Ä–µ–≤–æ –±—ã–ª–æ –≤–∏–¥–Ω–æ —Å–≤–µ—Ä—Ö—É
        g.attr("transform", `translate(${margin.left}, ${margin.top - minY})`);


        // –°–≤—è–∑–∏ (–≤–µ—Ç–≤–∏)
        g.selectAll(".link")
            .data(root.links())
            .enter().append("path")
            .attr("class", "link")
            .attr("d", d3.linkVertical()
                .x(d => d.x)
                .y(d => d.y));

        // –£–∑–ª—ã (–ª—é–¥–∏)
        const node = g.selectAll(".node")
            .data(root.descendants())
            .enter().append("g")
            .attr("class", d => "node" + (d.children ? " node--internal" : " node--leaf"))
            .attr("transform", d => `translate(${d.x},${d.y})`);

        node.append("circle")
            .attr("r", 15);

        node.append("text")
            .attr("dy", ".35em")
            .attr("y", d => d.children ? -25 : 20) // –ü–æ–∑–∏—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
            .text(d => d.data.name);

        // –ü–æ–¥–ø–∏—Å—å —Ä–æ–ª–∏ (–û—Ç–µ—Ü/–ú–∞—Ç—å)
        node.append("text")
            .attr("dy", ".35em")
            .attr("y", d => d.children ? 20 : -25) // –ü–æ–∑–∏—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
            .attr("font-size", "10px")
            .attr("fill", "#666")
            .text(d => d.data.role); // –î–æ–±–∞–≤–ª—è–µ–º —Ä–æ–ª—å
    }

    // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è D3.js
    function buildD3TreeData(data) {
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ—Ö, –∫—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è "—Ä–æ–¥–∏—Ç–µ–ª–µ–º" –¥–ª—è –∫–æ–≥–æ-–ª–∏–±–æ, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ "–∫–æ—Ä–Ω—è–º–∏"
        // (–¢.–µ. —Ç–µ, —É –∫–æ–≥–æ child === 'me' –∏–ª–∏ —á—å–µ–≥–æ child –Ω–µ—Ç –≤ localData)
        const rootNodes = Object.values(data).filter(person =>
            person.child === 'me' || !data[person.child]
        );

        if (rootNodes.length === 0) return null; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        const peopleById = new Map();
        Object.values(data).forEach(p => peopleById.set(p.id, { ...p, children: [] }));

        // –°–≤—è–∑—ã–≤–∞–µ–º –¥–µ—Ç–µ–π —Å —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏
        Object.values(data).forEach(p => {
            if (peopleById.has(p.child)) {
                peopleById.get(p.child).children.push(peopleById.get(p.id));
            }
        });

        // –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –¥—Ä–µ–≤–æ (–º—ã —Ä–∏—Å—É–µ–º –æ—Ç —Å–∞–º—ã—Ö –¥—Ä–µ–≤–Ω–∏—Ö –∫ "me")
        // –ù–∞–π–¥–µ–º –≤—Å–µ—Ö, —É –∫–æ–≥–æ –Ω–µ—Ç "–¥–µ—Ç–µ–π" –≤ —Ç–µ–∫—É—â–µ–º –Ω–∞–±–æ—Ä–µ, —ç—Ç–æ –Ω–∞—à–∏ "–ª–∏—Å—Ç—å—è" (–∫—Ä–æ–º–µ "me")
        const finalTreeRoots = Object.values(peopleById).filter(p => !p.children.length && p.child !== 'me');

        // –≠—Ç–æ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞, —Ç.–∫. D3 Tree layout —Å—Ç—Ä–æ–∏—Ç –æ—Ç –∫–æ—Ä–Ω—è –≤–Ω–∏–∑.
        // –ù–∞–º –Ω—É–∂–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å "–º–µ–Ω—è" –∫–∞–∫ –∫–æ—Ä–µ–Ω—å, –∞ –ø—Ä–µ–¥–∫–æ–≤ –∫–∞–∫ –≤–µ—Ç–≤–∏ –í–í–ï–†–•.
        // –ù–æ D3 —ç—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑. –ü–æ—ç—Ç–æ–º—É –º—ã —Å—Ç—Ä–æ–∏–º –¥–µ—Ä–µ–≤–æ –æ—Ç –ø—Ä–µ–¥–∫–æ–≤ "–≤–Ω–∏–∑" –∫ "–º–Ω–µ"
        // —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è D3, –Ω–æ –≤–∏–∑—É–∞–ª—å–Ω–æ —ç—Ç–æ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ "–≤–≤–µ—Ä—Ö".
       
        // –ü–µ—Ä–µ—Ñ–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–∞–∫, —á—Ç–æ–±—ã "me" –±—ã–ª –∫–æ—Ä–Ω–µ–º, –∞ –µ–≥–æ –ø—Ä–µ–¥–∫–∏ - –¥–æ—á–µ—Ä–Ω–∏–º–∏ —É–∑–ª–∞–º–∏
        const rootPerson = { id: 'me', name: '–Ø', role: '', children: [] };
        currentTreeData = [rootPerson]; // –û—á–∏—â–∞–µ–º –∏ –Ω–∞—á–∏–Ω–∞–µ–º —Å "–Ø"
       
        function findChildren(parentId) {
            return Object.values(localData).filter(p => p.child === parentId)
                .map(p => ({ ...p, children: findChildren(p.id) }));
        }

        rootPerson.children = findChildren('me');
        return rootPerson;
    }


    function exportToFile() {
        let text = "–ú–û–ï –®–ï–ñ–ò–†–ï\n====================\n";
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ "–ø–æ–∫–æ–ª–µ–Ω–∏—è–º" –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
        const sortedPeople = Object.values(localData).sort((a, b) => {
            let levelA = 0, levelB = 0;
            let current = a; while(current && current.child !== 'me') { current = localData[current.child]; levelA++; }
            current = b; while(current && current.child !== 'me') { current = localData[current.child]; levelB++; }
            return levelA - levelB;
        });

        sortedPeople.forEach(person => {
            const relation = person.child === 'me' ? "–≤–∞—Å" : (localData[person.child]?.name || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ");
            text += `- ${person.name} (${person.role} –¥–ª—è ${relation})\n`;
        });
       
        const blob = new Blob([text], { type: 'text/plain' });
        const anchor = document.createElement('a');
        anchor.download = 'sejire_tree.txt';
        anchor.href = URL.createObjectURL(blob);
        anchor.click();
        URL.revokeObjectURL(anchor.href);
    }

    function clearTree() {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å –¥–µ—Ä–µ–≤–æ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.")) {
            user.get('sejire_final').map().once((data, id) => {
                user.get('sejire_final').get(id).put(null); // –£–¥–∞–ª—è–µ–º –∫–∞–∂–¥—ã–π —É–∑–µ–ª
            });
            setTimeout(() => location.reload(), 1000); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
        }
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è SVG/PNG ---
    function downloadSvg() {
        const svgElement = document.getElementById('tree-canvas');
        const svgString = new XMLSerializer().serializeToString(svgElement);
        const blob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'sejire_tree.svg';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    async function downloadPng() {
        const svgElement = document.getElementById('tree-canvas');
        const svgString = new XMLSerializer().serializeToString(svgElement);
       
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // Canvg —Ç—Ä–µ–±—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
        const bbox = svgElement.getBBox();
        const width = bbox.width + 50; // –î–æ–±–∞–≤–∏–º –æ—Ç—Å—Ç—É–ø—ã
        const height = bbox.height + 50;
        canvas.width = width * 2; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–≥–æ PNG
        canvas.height = height * 2;
        ctx.scale(2, 2);

        await canvg.Canvg.from(ctx, svgString, {
            ignoreMouse: true, // –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –º—ã—à–∏
            ignoreAnimation: true, // –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏
            DOMParser: DOMParser // –ü–µ—Ä–µ–¥–∞–µ–º DOMParser
        });
       
        const link = document.createElement('a');
        link.download = 'sejire_tree.png';
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }


    if (user.is) showApp();
</script>
</body>
</html>