<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sejire Blockchain dApp</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root { --primary: #27ae60; --dark: #2c3e50; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }
       
        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        #auth-overlay { position: fixed; inset: 0; background: var(--dark); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: white; padding: 40px; border-radius: 15px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
       
        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .sidebar { width: 320px; background: white; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 10; overflow-y: auto; }
        #tree-area { flex-grow: 1; position: relative; background: #fff; cursor: grab; }
       
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }

        .node circle { fill: #fff; stroke: var(--primary); stroke-width: 3px; }
        .node text { font-size: 12px; font-weight: 600; }
        .link { fill: none; stroke: #cbd5e0; stroke-width: 2px; }

        #login-msg { font-size: 12px; color: #e67e22; margin-top: 10px; min-height: 15px; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-card">
        <h1 style="color:var(--primary); margin-bottom:10px;">Sejire</h1>
        <p style="font-size:14px; color:#666;">–î–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</p>
        <input type="text" id="u" placeholder="–õ–æ–≥–∏–Ω (alias)">
        <input type="password" id="p" placeholder="–ü–∞—Ä–æ–ª—å (passphrase)">
        <button id="login-btn" onclick="login()">–í–æ–π—Ç–∏ –∏–ª–∏ –°–æ–∑–¥–∞—Ç—å</button>
        <div id="login-msg"></div>
    </div>
</div>

<div class="sidebar">
    <h3>–ù–æ–≤—ã–π –ø—Ä–µ–¥–æ–∫</h3>
    <input type="text" id="name" placeholder="–§–ò–û">
    <div style="display:flex; gap:5px;">
        <input type="text" id="bYear" placeholder="–ì–æ–¥ —Ä–æ–∂–¥.">
        <input type="text" id="dYear" placeholder="–ì–æ–¥ —Å–º–µ—Ä—Ç–∏">
    </div>
    <select id="role"><option value="–û—Ç–µ—Ü">–û—Ç–µ—Ü</option><option value="–ú–∞—Ç—å">–ú–∞—Ç—å</option></select>
    <select id="child-select"><option value="me">–î–ª—è –º–µ–Ω—è</option></select>
    <button onclick="saveMember()">–î–æ–±–∞–≤–∏—Ç—å –≤ –±–ª–æ–∫—á–µ–π–Ω</button>
   
    <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
    <button style="background:#3498db" onclick="downloadPNG()">üì∑ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —Ñ–æ—Ç–æ</button>
    <button style="background:#e74c3c" onclick="clearAll()">‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –¥–µ—Ä–µ–≤–æ</button>
    <button style="background:#95a5a6" onclick="user.leave(); location.reload();">–í—ã—Ö–æ–¥</button>
</div>

<div id="tree-area">
    <svg id="canvas" width="100%" height="100%"></svg>
</div>

<script>
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ —É–∑–ª–∞–º–∏
    const gun = Gun({
        peers: [
            'https://gun-manhattan.herokuapp.com/gun',
            'https://relay.peer.ooo/gun'
        ],
        localStorage: true // –í–∞–∂–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ —Å–µ—Ç–∏
    });
    const user = gun.user().recall({storage: true});
    let treeData = {};

    // 2. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤—Ö–æ–¥–∞
    async function login() {
        const alias = document.getElementById('u').value;
        const pass = document.getElementById('p').value;
        const msg = document.getElementById('login-msg');
        const btn = document.getElementById('login-btn');

        if (!alias || !pass) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ");

        btn.disabled = true;
        msg.innerText = "–°–≤—è–∑—å —Å –±–ª–æ–∫—á–µ–π–Ω-—É–∑–ª–∞–º–∏...";

        // –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞
        user.auth(alias, pass, (ack) => {
            if (ack.err) {
                msg.innerText = "–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞...";
                user.create(alias, pass, (reg) => {
                    if (reg.err) {
                        msg.innerText = "–û—à–∏–±–∫–∞: " + reg.err;
                        btn.disabled = false;
                    } else {
                        // –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Ö–æ–¥–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                        user.auth(alias, pass, (final) => {
                            if (!final.err) location.reload();
                        });
                    }
                });
            } else {
                msg.innerText = "–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!";
                location.reload();
            }
        });

        // –¢–∞–π–º-–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —É–∑–ª—ã —Å–æ–≤—Å–µ–º –Ω–µ –æ—Ç–≤–µ—á–∞—é—Ç
        setTimeout(() => {
            if (btn.disabled && !user.is) {
                msg.innerText = "–°–µ—Ç—å —Ç–æ—Ä–º–æ–∑–∏—Ç. –ü—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ...";
                // –í GunDB –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —É–∂–µ –≤ localStorage
                if (user.is) location.reload();
                btn.disabled = false;
            }
        }, 8000);
    }

    // 3. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
    if (user.is) {
        document.getElementById('auth-overlay').style.display = 'none';
       
        // –°–ª—É—à–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≥—Ä–∞—Ñ–∞
        user.get('sejire_final_v1').map().on((data, id) => {
            if (data) {
                treeData[id] = {id, ...data};
                renderUI();
            }
        });
    }

    function saveMember() {
        const name = document.getElementById('name').value;
        if (!name) return;
       
        user.get('sejire_final_v1').get(Gun.text.random()).put({
            name,
            bYear: document.getElementById('bYear').value,
            dYear: document.getElementById('dYear').value,
            role: document.getElementById('role').value,
            child: document.getElementById('child-select').value
        });
        document.getElementById('name').value = '';
    }

    function renderUI() {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–µ–π
        const select = document.getElementById('child-select');
        select.innerHTML = '<option value="me">–î–ª—è –º–µ–Ω—è</option>';
        Object.values(treeData).forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id; opt.innerText = p.name;
            select.appendChild(opt);
        });

        // –°—Ç—Ä–æ–∏–º –¥–µ—Ä–µ–≤–æ D3
        const nest = (id) => Object.values(treeData).filter(d => d.child === id).map(d => ({...d, children: nest(d.id)}));
        const data = { name: "–Ø", id: "me", children: nest("me") };
       
        const root = d3.hierarchy(data);
        const layout = d3.tree().nodeSize([160, 120]);
        layout(root);

        const svg = d3.select("#canvas"), g = svg.select("g").empty() ? svg.append("g") : svg.select("g");
        g.selectAll("*").remove();

        // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
        g.attr("transform", `translate(${window.innerWidth/2 - 100}, 100)`);

        g.selectAll(".link").data(root.links()).enter().append("path").attr("class", "link")
            .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

        const node = g.selectAll(".node").data(root.descendants()).enter().append("g")
            .attr("class", "node").attr("transform", d => `translate(${d.x},${d.y})`);

        node.append("circle").attr("r", 6);
        node.append("text").attr("dy", "1.5em").attr("text-anchor", "middle").text(d => d.data.name);
        node.append("text").attr("dy", "-1.2em").attr("text-anchor", "middle").style("fill", "#999").style("font-size", "10px")
            .text(d => d.data.bYear ? `${d.data.bYear}-${d.data.dYear||'?'}` : "");
    }

    function downloadPNG() {
        const svgE = document.getElementById('canvas');
        const serializer = new XMLSerializer();
        const svgString = serializer.serializeToString(svgE);
        const canvas = document.createElement('canvas');
        canvas.width = svgE.clientWidth * 2;
        canvas.height = svgE.clientHeight * 2;
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
        img.onload = () => {
            ctx.fillStyle = "white";
            ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.scale(2,2); ctx.drawImage(img, 0, 0);
            const a = document.createElement('a');
            a.download = "tree.png"; a.href = canvas.toDataURL(); a.click();
        };
    }

    function clearAll() {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—ë?")) {
            user.get('sejire_final_v1').map().once((d, i) => user.get('sejire_final_v1').get(i).put(null));
            setTimeout(()=>location.reload(), 500);
        }
    }
</script>

</body>
</html>