<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sejire - –®–µ–∂–∏—Ä–µ</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root { --primary: #27ae60; --error: #e74c3c; --bg: #f4f7f6; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
       
        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ */
        #auth-overlay { position: fixed; inset: 0; background: rgba(44, 62, 80, 0.95); z-index: 999; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: white; padding: 30px; border-radius: 12px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .auth-card h2 { margin-top: 0; color: var(--primary); }
        .status-msg { margin-top: 10px; font-size: 12px; min-height: 1.5em; color: #555; font-weight: bold; }
       
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .app-container { display: flex; height: 100%; }
        .sidebar { width: 300px; background: white; padding: 20px; border-right: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; z-index: 10; }
        .main-area { flex-grow: 1; position: relative; background: white; cursor: grab; }
        .main-area:active { cursor: grabbing; }

        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 5px; font-weight: bold; }
        button.danger { background: var(--error); margin-top: 20px; font-size: 0.8em; }
        button.secondary { background: #95a5a6; }
       
        /* –°—Ç–∏–ª–∏ –¥–µ—Ä–µ–≤–∞ */
        .node circle { fill: #fff; stroke: var(--primary); stroke-width: 3px; }
        .node text { font: 12px sans-serif; font-weight: bold; }
        .node .dates { font-size: 10px; fill: #7f8c8d; font-weight: normal; }
        .link { fill: none; stroke: #ccc; stroke-width: 2px; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-card">
        <h2>Sejire –í—Ö–æ–¥</h2>
        <input type="text" id="u" placeholder="–í–∞—à–µ –ò–º—è (–õ–æ–≥–∏–Ω)">
        <input type="password" id="p" placeholder="–í–∞—à –ü–∞—Ä–æ–ª—å">
        <button id="login-btn" onclick="attemptLogin()">–í–æ–π—Ç–∏ / –°–æ–∑–¥–∞—Ç—å</button>
        <div id="msg" class="status-msg">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ</div>
       
        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
            <p style="font-size: 10px; color: #999;">–ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:</p>
            <button class="secondary" style="font-size: 10px; padding: 5px;" onclick="resetCache()">‚ö†Ô∏è –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–±—Ä–æ—Å</button>
        </div>
    </div>
</div>

<div class="app-container" id="app" style="filter: blur(5px);">
    <div class="sidebar">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–∫–∞</h3>
        <input type="text" id="name" placeholder="–§–ò–û">
        <div style="display: flex; gap: 5px;">
            <input type="text" id="bYear" placeholder="–ì–æ–¥ —Ä–æ–∂–¥.">
            <input type="text" id="dYear" placeholder="–ì–æ–¥ —Å–º–µ—Ä—Ç–∏">
        </div>
        <select id="role"><option value="–û—Ç–µ—Ü">–û—Ç–µ—Ü</option><option value="–ú–∞—Ç—å">–ú–∞—Ç—å</option></select>
        <label style="font-size: 12px; margin-top: 10px; display: block;">–ö–æ–º—É –æ–Ω —Ä–æ–¥–∏—Ç–µ–ª—å?</label>
        <select id="child-select"><option value="me">–ú–Ω–µ (–û—Å–Ω–æ–≤–∞–Ω–∏–µ)</option></select>
        <button onclick="saveData()">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥–µ—Ä–µ–≤–æ</button>
       
        <div style="margin-top: auto;">
            <button class="secondary" onclick="downloadPNG()">üì∑ –°–∫–∞—á–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
            <button class="danger" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>
   
    <div class="main-area" id="canvas-container">
        <svg id="canvas" width="100%" height="100%"></svg>
    </div>
</div>

<script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GUN
    const gun = Gun({
        peers: ['https://gun-manhattan.herokuapp.com/gun', 'https://relay.peer.ooo/gun'],
        localStorage: true
    });
    const user = gun.user().recall({storage: true});
    let treeData = {};

    // --- –õ–û–ì–ò–ö–ê –í–•–û–î–ê ---
    function attemptLogin() {
        const u = document.getElementById('u').value.trim();
        const p = document.getElementById('p').value.trim();
        const msg = document.getElementById('msg');
        const btn = document.getElementById('login-btn');

        if(!u || !p) return msg.innerText = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è!";

        btn.disabled = true;
        msg.innerText = "–ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞...";

        // 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è
        user.auth(u, p, (ack) => {
            if (ack.err) {
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å
                console.log("–í—Ö–æ–¥ –Ω–µ —É–¥–∞–ª—Å—è, –ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å...", ack.err);
                msg.innerText = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º...";
               
                user.create(u, p, (createAck) => {
                    if (createAck.err) {
                        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ú–û–ú–ï–ù–¢:
                        if (createAck.err.toLowerCase().includes("already")) {
                            msg.innerText = "‚ùå –û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!";
                            msg.style.color = "red";
                            alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ø–∞—Ä–æ–ª—å –Ω–µ –ø–æ–¥–æ—à–µ–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø–∞—Ä–æ–ª—å –∏–ª–∏ —Å–º–µ–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω.");
                        } else {
                            msg.innerText = "–û—à–∏–±–∫–∞: " + createAck.err;
                        }
                        btn.disabled = false;
                    } else {
                        // –°–æ–∑–¥–∞–ª–∏ —É—Å–ø–µ—à–Ω–æ -> –≤—Ö–æ–¥–∏–º
                        msg.innerText = "–£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è! –í—Ö–æ–¥–∏–º...";
                        user.auth(u, p);
                    }
                });
            } else {
                // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
                msg.innerText = "–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!";
                startApp();
            }
        });
    }

    // –ï—Å–ª–∏ Gun —Å–∞–º –≤—Å–ø–æ–º–Ω–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–≤—Ç–æ-–≤—Ö–æ–¥)
    gun.on('auth', () => {
        startApp();
    });

    function startApp() {
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('app').style.filter = 'none';
       
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        user.get('sejire_v5').map().on((data, id) => {
            if (data) {
                treeData[id] = { id, ...data };
                updateUI();
            }
        });
    }

    // –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–±—Ä–æ—Å, –µ—Å–ª–∏ –≤—Å—ë –∑–∞–≤–∏—Å–ª–æ
    function resetCache() {
        if(confirm("–≠—Ç–æ —Å–±—Ä–æ—Å–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Ö–æ–¥–∞ (–¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Ç–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è). –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) {
            localStorage.clear();
            sessionStorage.clear();
            location.reload();
        }
    }

    function logout() {
        user.leave();
        location.reload();
    }

    // --- –õ–û–ì–ò–ö–ê –î–ê–ù–ù–´–• ---
    function saveData() {
        const name = document.getElementById('name').value;
        if (!name) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");

        user.get('sejire_v5').get(Gun.text.random()).put({
            name: name,
            bYear: document.getElementById('bYear').value,
            dYear: document.getElementById('dYear').value,
            role: document.getElementById('role').value,
            child: document.getElementById('child-select').value
        });
       
        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
        document.getElementById('name').value = '';
        document.getElementById('bYear').value = '';
        document.getElementById('dYear').value = '';
    }

    // --- –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø ---
    const svg = d3.select("#canvas");
    const g = svg.append("g");
   
    // –ó—É–º –∏ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ
    const zoom = d3.zoom().on("zoom", (e) => g.attr("transform", e.transform));
    svg.call(zoom);
   
    // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
    svg.call(zoom.transform, d3.zoomIdentity.translate(window.innerWidth/2, 50).scale(0.8));

    function updateUI() {
        const select = document.getElementById('child-select');
        const currentVal = select.value;
        select.innerHTML = '<option value="me">–ú–Ω–µ (–û—Å–Ω–æ–≤–∞–Ω–∏–µ)</option>';
       
        Object.values(treeData).forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.innerText = p.name;
            select.appendChild(opt);
        });
        select.value = currentVal; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä

        renderTree();
    }

    function renderTree() {
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        const nest = (id) => Object.values(treeData)
            .filter(d => d.child === id)
            .map(d => ({ ...d, children: nest(d.id) }));

        const data = { name: "–Ø", id: "me", children: nest("me") };
        const root = d3.hierarchy(data);
        const treeLayout = d3.tree().nodeSize([180, 140]); // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —É–∑–ª–∞–º–∏
        treeLayout(root);

        g.selectAll("*").remove(); // –û—á–∏—Å—Ç–∫–∞

        // –†–∏—Å—É–µ–º —Å–≤—è–∑–∏
        g.selectAll(".link")
            .data(root.links())
            .enter().append("path")
            .attr("class", "link")
            .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

        // –†–∏—Å—É–µ–º —É–∑–ª—ã
        const node = g.selectAll(".node")
            .data(root.descendants())
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.x},${d.y})`);

        node.append("circle").attr("r", 6);

        // –¢–µ–∫—Å—Ç –∏–º–µ–Ω–∏ (—Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º)
        node.append("text")
            .attr("dy", "1.6em")
            .attr("text-anchor", "middle")
            .each(function(d) {
                const parts = d.data.name.split(" ");
                d3.select(this).selectAll("tspan")
                    .data(parts).enter().append("tspan")
                    .attr("x", 0)
                    .attr("dy", (d, i) => i === 0 ? 0 : "1.2em")
                    .text(d => d);
            });
           
        // –î–∞—Ç—ã
        node.append("text")
            .attr("class", "dates")
            .attr("dy", "-1.5em")
            .attr("text-anchor", "middle")
            .text(d => (d.data.bYear || d.data.dYear) ? `${d.data.bYear || '?'} - ${d.data.dYear || '?'}` : "");
    }

    function downloadPNG() {
        const svgEl = document.getElementById("canvas");
        const serializer = new XMLSerializer();
        const source = serializer.serializeToString(svgEl);
       
        const canvas = document.createElement("canvas");
        const rect = svgEl.getBoundingClientRect();
        canvas.width = rect.width * 2;
        canvas.height = rect.height * 2;
       
        const ctx = canvas.getContext("2d");
        ctx.scale(2, 2);
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, rect.width, rect.height);
       
        const img = new Image();
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(source)));
       
        img.onload = function() {
            ctx.drawImage(img, 0, 0);
            const a = document.createElement("a");
            a.download = "sejire.png";
            a.href = canvas.toDataURL("image/png");
            a.click();
        }
    }
</script>

</body>
</html>



